<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Admin Dashboard — RFID Console</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css?family=Nunito:400,700,800" rel="stylesheet">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">

<style>
:root{
  --bg:#020617;
  --card:rgba(255,255,255,.08);
  --border:rgba(255,255,255,.15);
  --primary:#38bdf8;
  --text:#e5e7eb;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Nunito,system-ui;
  background:linear-gradient(120deg,#020617,#0f172a);
  color:var(--text);
  height:100vh;
  display:flex;
}

/* SIDEBAR */
#sidebar{
  width:64px;
  background:#020617;
  border-right:1px solid var(--border);
  padding:18px 10px;
  transition:.3s;
}
#sidebar:hover{width:180px}
#sidebar a{
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px;
  color:#cbd5f5;
  text-decoration:none;
  border-radius:10px;
}
#sidebar a:hover{background:rgba(255,255,255,.06)}
#sidebar span{opacity:0;transition:.2s}
#sidebar:hover span{opacity:1}

/* MAIN */
.main{
  flex:1;
  padding:24px;
  display:flex;
  flex-direction:column;
  gap:20px;
}

.header{
  font-size:22px;
  font-weight:800;
}

/* DASHBOARD GRID */
.dashboard{
  flex:1;
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:24px;
}

/* CARD */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:20px;
}

/* TABLE */
.table-wrap{overflow:auto}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:14px;
  font-size:14px;
  border-bottom:1px solid var(--border);
}
th{
  text-align:left;
  color:#7dd3fc;
  font-weight:700;
}
tbody tr:hover{
  background:rgba(255,255,255,.03);
}

/* FILTER TABS */
.tabs{
  display:flex;
  gap:10px;
  margin-bottom:14px;
}
.tab{
  flex:1;
  padding:10px;
  text-align:center;
  border-radius:10px;
  border:1px solid var(--border);
  cursor:pointer;
}
.tab.active{
  background:var(--primary);
  color:#000;
}

/* FORM */
label{
  font-size:13px;
  margin-top:12px;
  display:block;
}
input,select{
  width:100%;
  padding:12px;
  margin-top:6px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#020617;
  color:var(--text);
}
button{
  padding:12px;
  border-radius:12px;
  border:none;
  cursor:pointer;
  font-weight:700;
}
.primary{background:var(--primary);color:#000}
.secondary{background:transparent;border:1px solid var(--border);color:#cbd5f5}

.actions{
  display:flex;
  gap:10px;
  margin-top:16px;
}

.badge{
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
}
.guest{background:#334155}
.basic{background:#38bdf8;color:#000}
.premium{background:#22c55e;color:#000}
.admin{background:#ef4444}

.action-btn{
  padding:6px 10px;
  border-radius:8px;
  border:none;
  cursor:pointer;
}
.edit{background:#38bdf8;color:#000}
.delete{background:#ef4444;color:#fff}

#log{margin-top:10px;font-size:13px;color:#7dd3fc}
</style>
</head>

<body>

<!-- SIDEBAR -->
<div id="sidebar">
  <a href="/index.html"><i class="fas fa-home"></i><span>Home</span></a>
  <a href="#"><i class="fas fa-database"></i><span>Database</span></a>
  <a href="#"><i class="fas fa-user"></i><span>Accounts</span></a>
</div>

<!-- MAIN -->
<div class="main">

  <div class="header">Admin Dashboard — RFID Console</div>

  <div class="dashboard">

    <!-- DATABASE -->
    <div class="card">
      <h3>Database</h3>

      <div class="tabs">
        <div class="tab active" data-cottage="COTTAGE-1">Cottage 1</div>
        <div class="tab" data-cottage="COTTAGE-2">Cottage 2</div>
        <div class="tab" data-cottage="COTTAGE-3">Cottage 3</div>
        <div class="tab" data-cottage="COTTAGE-4">Cottage 4</div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Employee</th>
              <th>Access</th>
              <th>Valid</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTable"></tbody>
        </table>
      </div>
    </div>

    <!-- REGISTER -->
    <div class="card">
      <h3>Register Card</h3>

      <label>Card UID
        <input id="uid" readonly placeholder="Tap card...">
      </label>

      <label>Name
        <input id="name">
      </label>

      <label>Employee ID
        <input id="employee_id">
      </label>

      <label>Access Level
        <select id="access_level">
          <option value="guest">Guest</option>
          <option value="basic">Basic</option>
          <option value="premium">Premium</option>
          <option value="admin">Admin</option>
        </select>
      </label>

      <label>Valid Until
        <input id="valid_until" type="date">
      </label>

      <label>Cottage
        <select id="cottage">
          <option value="COTTAGE-1">Cottage 1</option>
          <option value="COTTAGE-2">Cottage 2</option>
          <option value="COTTAGE-3">Cottage 3</option>
          <option value="COTTAGE-4">Cottage 4</option>
        </select>
      </label>

      <div class="actions">
        <button class="primary" onclick="save()">Save</button>
        <button class="secondary" onclick="clearForm()">Clear</button>
      </div>

      <div id="log">Connected. Tap card.</div>
    </div>

  </div>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
const socket = io();
const table = document.getElementById("usersTable");
let currentCottage="COTTAGE-1";

socket.on("card_tapped",d=>{
  if(d.uid) document.getElementById("uid").value=d.uid;
});

document.querySelectorAll(".tab").forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    currentCottage=t.dataset.cottage;
    loadUsers();
  }
});

async function loadUsers(){
  const res=await fetch(`/api/users?cottage=${currentCottage}`);
  const users=await res.json();
  table.innerHTML="";
  users.forEach(u=>{
    table.innerHTML+=`
      <tr>
        <td>${u.name||""}</td>
        <td>${u.employee_id||""}</td>
        <td><span class="badge ${u.access_level}">${u.access_level}</span></td>
        <td>${u.valid_until||"-"}</td>
        <td>${u.created_at?new Date(u.created_at).toLocaleDateString():""}</td>
        <td>
          <button class="action-btn edit">Edit</button>
          <button class="action-btn delete" onclick="del('${u.uid}')">Delete</button>
        </td>
      </tr>`;
  });
}

async function save(){
  const payload={
    uid:uid.value,
    name:name.value,
    employee_id:employee_id.value,
    access_level:access_level.value,
    valid_until:valid_until.value,
    cottage:cottage.value
  };
  await fetch("/api/register_card",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  clearForm(); loadUsers();
}

function clearForm(){
  uid.value="";name.value="";employee_id.value="";valid_until.value="";
}

async function del(uid){
  if(confirm("Delete?")){
    await fetch(`/api/users/${uid}`,{method:"DELETE"});
    loadUsers();
  }
}

loadUsers();
</script>
</body>
</html>
